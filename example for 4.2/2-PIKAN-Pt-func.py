"""
solve the following ODE of MDOF
M*U_dotdot+C*U_dot+K*U=Pt with initial condition: U(t=0)=0, and U_dot(t=0)=0
Pt is a continuous function
Author: 杜轲 duke@iem.ac.cn
Date: 2024/11/3
"""
###########################环境配置##################
# 导入所需的库
from AIStructDynSolve import *
from AIStructDynSolve.config import DEVICE
import numpy as np
import torch
################ 输入结构动力学参数 #################
# 定义质量矩阵
M = np.array([
 [ 5.20000000e+01, -2.14894027e-16, -9.76835449e-16,  4.05150189e-16,
   1.82382321e-16, -4.59502812e-16, -2.90143636e-17, -4.18047577e-16,
   3.81579206e-17,  1.71938521e-18,  3.83357911e-17, -2.50706444e-17,
  -1.20017461e-19, -2.92111829e-18, -4.11860271e-18,  2.62423367e-19,
   7.80764244e-19, -1.14687291e-19],
 [-2.14894027e-16,  1.04000000e+02,  1.99854584e-16, -4.43585873e-16,
  -1.69819917e-16,  1.96373591e-17,  3.36016853e-17,  4.42594482e-16,
  -2.77969586e-17, -2.03831268e-18, -4.25613066e-17,  1.36277942e-17,
   1.41711040e-19,  3.32075108e-18,  6.56931648e-18, -3.00905331e-19,
  -1.11103349e-18,  1.55300086e-19],
 [-9.76835449e-16,  1.99854584e-16,  4.78500000e+01, -4.15725318e-16,
  -2.49915379e-16, -6.31798392e-17,  3.34343218e-17,  6.36406427e-16,
   8.47414215e-18, -2.24660958e-18, -6.41150765e-17, -9.94910419e-17,
   1.80116327e-19,  5.25724638e-18,  1.85348624e-17, -5.04164691e-19,
  -2.21323435e-18,  2.92016001e-19],
 [ 4.05150189e-16, -4.43585873e-16, -4.15725318e-16,  1.04000000e+02,
   4.14720129e-16, -2.14396528e-17, -9.28474508e-16, -7.25321902e-15,
   4.48808861e-17,  7.12853979e-17,  1.06260299e-15, -8.21729625e-17,
  -6.11370126e-18, -1.00462684e-16, -1.00303608e-16,  1.06869951e-17,
   2.43525298e-17, -4.03769752e-18],
 [ 1.82382321e-16, -1.69819917e-16, -2.49915379e-16,  4.14720129e-16,
   9.57000000e+01,  2.83818642e-17, -3.61367605e-17, -5.91235619e-16,
  -7.08773685e-18,  2.59676379e-18,  6.44893912e-17,  9.34476715e-17,
  -2.26324486e-19, -5.64736792e-18, -1.94611325e-17,  5.83786646e-19,
   2.47247187e-18, -3.40484287e-19],
 [-4.59502812e-16,  1.96373591e-17, -6.31798392e-17, -2.14396528e-17,
   2.83818642e-17,  4.78500000e+01,  4.09645726e-19, -1.04819988e-16,
  -5.76261425e-17,  3.09727055e-20,  1.36868808e-17,  1.90595877e-16,
  -5.19401818e-21, -1.37398409e-18, -2.67727140e-17,  1.64749345e-19,
   3.09969888e-18, -4.37399339e-19],
 [-2.90143636e-17,  3.36016853e-17,  3.34343218e-17, -9.28474508e-16,
  -3.61367605e-17,  4.09645726e-19,  1.04000000e+02,  1.03992593e-15,
  -7.96569225e-19, -8.31881989e-16, -7.18720891e-15, -7.00241722e-17,
   8.19162299e-17,  9.47333068e-16,  2.35715049e-17, -1.14923496e-16,
  -8.62620597e-17,  2.61099004e-17],
 [-4.18047577e-16,  4.42594482e-16,  6.36406427e-16, -7.25321902e-15,
  -5.91235619e-16, -1.04819988e-16,  1.03992593e-15,  9.57000000e+01,
   6.00492401e-17, -9.69345051e-17, -1.68544711e-15, -1.69228404e-15,
   1.05826157e-17,  1.84242168e-16,  4.54799567e-16, -2.30788074e-17,
  -7.07258077e-17,  1.15852380e-17],
 [ 3.81579206e-17, -2.77969586e-17,  8.47414215e-18,  4.48808861e-17,
  -7.08773685e-18, -5.76261425e-17, -7.96569225e-19,  6.00492401e-17,
   9.57000000e+01, -1.89349245e-19, -1.14371745e-17, -1.38078000e-16,
   4.65432216e-20,  1.45169457e-18,  2.08832939e-17, -2.18039977e-19,
  -2.65352113e-18,  4.25144556e-19],
 [ 1.71938521e-18, -2.03831268e-18, -2.24660958e-18,  7.12853979e-17,
   2.59676379e-18,  3.09727055e-20, -8.31881989e-16, -9.69345051e-17,
  -1.89349245e-19,  1.04000000e+02,  9.47306013e-16,  1.92595996e-17,
  -1.06833702e-15, -7.21031101e-15, -8.62656173e-17,  1.23408906e-15,
   3.19918168e-17, -1.20071353e-16],
 [ 3.83357911e-17, -4.25613066e-17, -6.41150765e-17,  1.06260299e-15,
   6.44893912e-17,  1.36868808e-17, -7.18720891e-15, -1.68544711e-15,
  -1.14371745e-17,  9.47306013e-16,  9.57000000e+01,  4.21678347e-16,
  -1.18283615e-16, -1.52345024e-15, -1.76494475e-15,  2.22486059e-16,
   4.09712864e-16, -8.45923877e-17],
 [-2.50706444e-17,  1.36277942e-17, -9.94910419e-17, -8.21729625e-17,
   9.34476715e-17,  1.90595877e-16, -7.00241722e-17, -1.69228404e-15,
  -1.38078000e-16,  1.92595996e-17,  4.21678347e-16,  9.57000000e+01,
  -3.90411044e-18, -6.50185515e-17, -5.74848148e-16,  1.14243994e-17,
   9.00955384e-17, -1.71894237e-17],
 [-1.20017461e-19,  1.41711040e-19,  1.80116327e-19, -6.11370126e-18,
  -2.26324486e-19, -5.19401818e-21,  8.19162299e-17,  1.05826157e-17,
   4.65432216e-20, -1.06833702e-15, -1.18283615e-16, -3.90411044e-18,
   5.20000000e+01,  1.25561556e-15,  3.13940311e-17, -8.66624582e-15,
  -1.50959646e-16,  1.69777847e-16],
 [-2.92111829e-18,  3.32075108e-18,  5.25724638e-18, -1.00462684e-16,
  -5.64736792e-18, -1.37398409e-18,  9.47333068e-16,  1.84242168e-16,
   1.45169457e-18, -7.21031101e-15, -1.52345024e-15, -6.50185515e-17,
   1.25561556e-15,  9.57000000e+01,  4.09712946e-16, -2.04701089e-15,
  -1.78997366e-15,  5.68331832e-16],
 [-4.11860271e-18,  6.56931648e-18,  1.85348624e-17, -1.00303608e-16,
  -1.94611325e-17, -2.67727140e-17,  2.35715049e-17,  4.54799567e-16,
   2.08832939e-17, -8.62656173e-17, -1.76494475e-15, -5.74848148e-16,
   3.13940311e-17,  4.09712946e-16,  9.57000000e+01, -9.04852405e-17,
  -5.32902990e-16,  1.18550340e-16],
 [ 2.62423367e-19, -3.00905331e-19, -5.04164691e-19,  1.06869951e-17,
   5.83786646e-19,  1.64749345e-19, -1.14923496e-16, -2.30788074e-17,
  -2.18039977e-19,  1.23408906e-15,  2.22486059e-16,  1.14243994e-17,
  -8.66624582e-15, -2.04701089e-15, -9.04852405e-17,  4.78500000e+01,
   6.02127492e-16, -2.43484731e-15],
 [ 7.80764244e-19, -1.11103349e-18, -2.21323435e-18,  2.43525298e-17,
   2.47247187e-18,  3.09969888e-18, -8.62620597e-17, -7.07258077e-17,
  -2.65352113e-18,  3.19918168e-17,  4.09712864e-16,  9.00955384e-17,
  -1.50959646e-16, -1.78997366e-15, -5.32902990e-16,  6.02127492e-16,
   9.57000000e+01, -7.66463536e-16],
 [-1.14687291e-19,  1.55300086e-19,  2.92016001e-19, -4.03769752e-18,
  -3.40484287e-19, -4.37399339e-19,  2.61099004e-17,  1.15852380e-17,
   4.25144556e-19, -1.20071353e-16, -8.45923877e-17, -1.71894237e-17,
   1.69777847e-16,  5.68331832e-16,  1.18550340e-16, -2.43484731e-15,
  -7.66463536e-16,  4.78500000e+01]
])  # 质量矩阵



# 定义刚度矩阵
K = np.array([
 [ 1.90191791e+05, -1.88752881e+05, -1.61488679e+03, -1.25344196e+02,
  -5.39395206e+01,  2.73793206e+02,  8.45297732e+00,  1.11667706e+02,
  -1.85787967e+01, -4.73948016e-01, -9.37163880e+00,  2.77359007e+01,
   3.14706285e-02,  6.60655974e-01, -1.37603592e+00, -5.47027703e-02,
   5.13679868e-02, -3.07004622e-03],
 [-1.88752881e+05,  4.82560997e+05, -5.72674204e+01, -2.91528643e+05,
  -1.85242519e+03, -1.53400637e+01, -2.78637313e+01, -3.12878977e+02,
   6.72038195e+01,  1.50649082e+00,  2.44708199e+01, -1.36340577e+02,
  -9.63731492e-02, -1.60883593e+00,  9.69034758e+00,  1.24658462e-01,
  -6.62857208e-01,  6.84972231e-02],
 [-1.61488679e+03, -5.72674204e+01,  1.92130028e+05,  1.13701374e+02,
  -1.88746885e+05, -1.99559792e+03, -8.94444338e+00, -1.86408369e+02,
  -1.44026984e+00,  5.91517894e-01,  1.80690362e+01,  1.96909378e+01,
  -4.60699292e-02, -1.42140947e+00, -3.38925610e+00,  1.28040103e-01,
   3.63611731e-01, -4.16563220e-02],
 [-1.25344196e+02, -2.91528643e+05,  1.13701374e+02,  6.04254878e+05,
  -3.23352629e+02,  2.40117361e+01, -2.89238881e+05, -2.84973201e+04,
  -1.24634196e+02, -1.44000505e+02, -2.27963604e+03,  9.58934985e+03,
   8.73696293e+00,  1.47630278e+02, -7.22338109e+02, -1.13084511e+01,
   3.61391739e+01, -2.45568465e+00],
 [-5.39395206e+01, -1.85242519e+03, -1.88746885e+05, -3.23352629e+02,
   6.89369138e+05, -4.97544502e+00,  2.59644274e+01, -4.96212555e+05,
  -2.00208366e+03, -1.75508087e+00, -5.24469773e+01, -3.59003066e+01,
   1.40828818e-01,  4.12570952e+00,  6.24654884e+00, -3.70610119e-01,
  -6.15932258e-01,  5.92817751e-02],
 [ 2.73793206e+02, -1.53400637e+01, -1.99559792e+03,  2.40117361e+01,
  -4.97544502e+00,  1.92518882e+05, -1.43983083e+00,  2.38048550e+01,
  -1.88801287e+05,  8.39364788e-02, -3.28723551e+00, -6.68644661e+01,
  -8.42779783e-03,  3.20202205e-01,  8.56206215e+00, -3.42582109e-02,
  -9.22994695e-01,  1.20541756e-01],
 [ 8.45297732e+00, -2.78637313e+01, -8.94444338e+00, -2.89238881e+05,
   2.59644274e+01, -1.43983083e+00,  6.07891162e+05, -2.28297149e+03,
   7.43518898e+00, -2.89112624e+05, -3.46028529e+04, -7.18536650e+02,
  -1.63787313e+02, -2.39909320e+03,  1.26509756e+04,  1.71899207e+02,
  -7.51849174e+02,  4.11757480e+01],
 [ 1.11667706e+02, -3.12878977e+02, -1.86408369e+02, -2.84973201e+04,
  -4.96212555e+05,  2.38048550e+01, -2.28297149e+03,  1.06302523e+06,
  -4.81610131e+01,  1.47807496e+02, -4.92526426e+05, -5.33168809e+04,
  -1.13028435e+01, -3.28628221e+02, -5.70619405e+02,  2.93338537e+01,
   6.48400839e+01, -7.37531268e+00],
 [-1.85787967e+01,  6.72038195e+01, -1.44026984e+00, -1.24634196e+02,
  -2.00208366e+03, -1.88801287e+05,  7.43518898e+00, -4.81610131e+01,
   6.96776420e+05, -3.82264943e-01,  8.57728527e+00, -5.03803386e+05,
   2.96143541e-02, -9.09321392e-01, -2.55118546e+01,  1.00730811e-01,
   2.65823012e+00, -3.40894191e-01],
 [-4.73948016e-01,  1.50649082e+00,  5.91517894e-01, -1.44000505e+02,
  -1.75508087e+00,  8.39364788e-02, -2.89112624e+05,  1.47807496e+02,
  -3.82264943e-01,  6.07864196e+05, -2.39904106e+03,  3.57005651e+01,
  -2.88878748e+05, -3.45720193e+04, -7.51866304e+02, -2.63580171e+03,
   1.26589143e+04, -8.12421167e+02],
 [-9.37163880e+00,  2.44708199e+01,  1.80690362e+01, -2.27963604e+03,
  -5.24469773e+01, -3.28723551e+00, -3.46028529e+04, -4.92526426e+05,
   8.57728527e+00, -2.39904106e+03,  1.07902309e+06, -5.74835193e+02,
   1.71731634e+02, -4.92275154e+05, -6.74700669e+04, -3.90401495e+02,
  -6.24266217e+02,  8.09823439e+01],
 [ 2.77359007e+01, -1.36340577e+02,  1.96909378e+01,  9.58934985e+03,
  -3.59003066e+01, -6.68644661e+01, -7.18536650e+02, -5.33168809e+04,
  -5.03803386e+05,  3.57005651e+01, -5.74835193e+02,  1.10581477e+06,
  -2.40620747e+00,  6.53308003e+01, -5.02149404e+05, -7.43303408e+00,
  -1.89270690e+02,  2.38588922e+01],
 [ 3.14706285e-02, -9.63731492e-02, -4.60699292e-02,  8.73696293e+00,
   1.40828818e-01, -8.42779783e-03, -1.63787313e+02, -1.13028435e+01,
   2.96143541e-02, -2.88878748e+05,  1.71731634e+02, -2.40620747e+00,
   3.07367230e+05, -2.63529606e+03,  4.12753825e+01, -2.42700179e+04,
  -8.12721856e+02,  1.08471464e+04],
 [ 6.60655974e-01, -1.60883593e+00, -1.42140947e+00,  1.47630278e+02,
   4.12570952e+00,  3.20202205e-01, -2.39909320e+03, -3.28628221e+02,
  -9.09321392e-01, -3.45720193e+04, -4.92275154e+05,  6.53308003e+01,
  -2.63529606e+03,  1.07894368e+06, -6.24246960e+02, -4.91742706e+05,
  -6.74498645e+04, -7.32592349e+02],
 [-1.37603592e+00,  9.69034758e+00, -3.38925610e+00, -7.22338109e+02,
   6.24654884e+00,  8.56206215e+00,  1.26509756e+04, -5.70619405e+02,
  -2.55118546e+01, -7.51866304e+02, -6.74700669e+04, -5.02149404e+05,
   4.12753825e+01, -6.24246960e+02,  1.13129388e+06,  8.08630738e+01,
  -5.02002540e+05, -2.38464809e+02],
 [-5.47027703e-02,  1.24658462e-01,  1.28040103e-01, -1.13084511e+01,
  -3.70610119e-01, -3.42582109e-02,  1.71899207e+02,  2.93338537e+01,
   1.00730811e-01, -2.63580171e+03, -3.90401495e+02, -7.43303408e+00,
  -2.42700179e+04, -4.91742706e+05,  8.08630738e+01,  5.58424627e+05,
  -7.32229428e+02, -5.21912984e+04],
 [ 5.13679868e-02, -6.62857208e-01,  3.63611731e-01,  3.61391739e+01,
  -6.15932258e-01, -9.22994695e-01, -7.51849174e+02,  6.48400839e+01,
   2.65823012e+00,  1.26589143e+04, -6.24266217e+02, -1.89270690e+02,
  -8.12721856e+02, -6.74498645e+04, -5.02002540e+05, -7.32229428e+02,
   1.13123026e+06, -5.01683529e+05],
 [-3.07004622e-03,  6.84972231e-02, -4.16563220e-02, -2.45568465e+00,
   5.92817751e-02,  1.20541756e-01,  4.11757480e+01, -7.37531268e+00,
  -3.40894191e-01, -8.12421167e+02,  8.09823439e+01,  2.38588922e+01,
   1.08471464e+04, -7.32592349e+02, -2.38464809e+02, -5.21912984e+04,
  -5.01683529e+05,  5.98273713e+05]
])  # 刚度矩阵

# 定义阻尼矩阵
C =np.array([
 [ 2.12046765e+02, -1.99240775e+02, -1.70461660e+00, -1.32308840e-01,
  -5.69366242e-02,  2.89006293e-01,  8.92265982e-03,  1.17872427e-01,
  -1.96111117e-02, -5.00282534e-04, -9.89236594e-03,  2.92770224e-02,
   3.32192673e-05,  6.97364761e-04, -1.45249418e-03, -5.77422832e-05,
   5.42222053e-05, -3.24063073e-06],
 [-1.99240775e+02,  5.31948347e+02, -6.04494360e-02, -3.07727184e+02,
  -1.95535363e+00, -1.61924212e-02, -2.94119558e-02, -3.30263831e-01,
   7.09379426e-02,  1.59019770e-03,  2.58305202e-02, -1.43916226e-01,
  -1.01728041e-04, -1.69822953e-03,  1.02287835e-02,  1.31585003e-04,
  -6.99688305e-04,  7.23032131e-05],
 [-1.70461660e+00, -6.04494360e-02,  2.13191900e+02,  1.20019094e-01,
  -1.99234445e+02, -2.10648162e+00, -9.44143377e-03, -1.96765991e-01,
  -1.52029721e-03,  6.24385083e-04,  1.90730268e-02,  2.07850481e-02,
  -4.86297657e-05, -1.50038888e-03, -3.57757724e-03,  1.35154543e-04,
   3.83815507e-04, -4.39709201e-05],
 [-1.32308840e-01, -3.07727184e+02,  1.20019094e-01,  6.60404045e+02,
  -3.41319443e-01,  2.53459278e-02, -3.05310194e+02, -3.00807495e+01,
  -1.31559389e-01, -1.52001771e-01, -2.40630207e+00,  1.01221739e+01,
   9.22242485e-03,  1.55833229e-01, -7.62474212e-01, -1.19367956e-02,
   3.81472164e-02, -2.59213268e-03],
 [-5.69366242e-02, -1.95535363e+00, -1.99234445e+02, -3.41319443e-01,
   7.48446007e+02, -5.25190140e-03,  2.74071187e-02, -5.23784184e+02,
  -2.11332774e+00, -1.85260045e-03, -5.53611490e-02, -3.78950766e-02,
   1.48653851e-04,  4.35495107e-03,  6.59363301e-03, -3.91202755e-04,
  -6.50156010e-04,  6.25757165e-05],
 [ 2.89006293e-01, -1.61924212e-02, -2.10648162e+00,  2.53459278e-02,
  -5.25190140e-03,  2.13602360e+02, -1.51983381e-03,  2.51275515e-02,
  -1.99291870e+02,  8.86003379e-05, -3.46988796e-03, -7.05797333e-02,
  -8.89608125e-06,  3.37993968e-04,  9.03780585e-03, -3.61617393e-05,
  -9.74280110e-04,  1.27239557e-04],
 [ 8.92265982e-03, -2.94119558e-02, -9.44143377e-03, -3.05310194e+02,
   2.74071187e-02, -1.51983381e-03,  6.64242376e+02, -2.40982286e+00,
   7.84831894e-03, -3.05176921e+02, -3.65255310e+01, -7.58461528e-01,
  -1.72888016e-01, -2.53239678e+00,  1.33539163e+01,  1.81450641e-01,
  -7.93625034e-01,  4.34636434e-02],
 [ 1.17872427e-01, -3.30263831e-01, -1.96765991e-01, -3.00807495e+01,
  -5.23784184e+02,  2.51275515e-02, -2.40982286e+00,  1.14286398e+03,
  -5.08370389e-02,  1.56020294e-01, -5.19893238e+02, -5.62793881e+01,
  -1.19308764e-02, -3.46888169e-01, -6.02325388e-01,  3.09637643e-02,
   6.84428680e-02, -7.78511565e-03],
 [-1.96111117e-02,  7.09379426e-02, -1.52029721e-03, -1.31559389e-01,
  -2.11332774e+00, -1.99291870e+02,  7.84831894e-03, -5.08370389e-02,
   7.56264869e+02, -4.03505170e-04,  9.05387484e-03, -5.31796793e+02,
   3.12598505e-05, -9.59847063e-04, -2.69293991e-02,  1.06327833e-04,
   2.80593241e-03, -3.59835687e-04],
 [-5.00282534e-04,  1.59019770e-03,  6.24385083e-04, -1.52001771e-01,
  -1.85260045e-03,  8.86003379e-05, -3.05176921e+02,  1.56020294e-01,
  -4.03505170e-04,  6.64213912e+02, -2.53234173e+00,  3.76842367e-02,
  -3.04930050e+02, -3.64929842e+01, -7.93643116e-01, -2.78225779e+00,
   1.33622961e+01, -8.57562659e-01],
 [-9.89236594e-03,  2.58305202e-02,  1.90730268e-02, -2.40630207e+00,
  -5.53611490e-02, -3.46988796e-03, -3.65255310e+01, -5.19893238e+02,
   9.05387484e-03, -2.53234173e+00,  1.15975075e+03, -6.06775422e-01,
   1.81273756e-01, -5.19628004e+02, -7.12189838e+01, -4.12093822e-01,
  -6.58953039e-01,  8.54820589e-02],
 [ 2.92770224e-02, -1.43916226e-01,  2.07850481e-02,  1.01221739e+01,
  -3.78950766e-02, -7.05797333e-02, -7.58461528e-01, -5.62793881e+01,
  -5.31796793e+02,  3.76842367e-02, -6.06775422e-01,  1.18803109e+03,
  -2.53990634e-03,  6.89608507e-02, -5.30050908e+02, -7.84604430e-03,
  -1.99787355e-01,  2.51845913e-02],
 [ 3.32192673e-05, -1.01728041e-04, -4.86297657e-05,  9.22242485e-03,
   1.48653851e-04, -8.89608125e-06, -1.72888016e-01, -1.19308764e-02,
   3.12598505e-05, -3.04930050e+02,  1.81273756e-01, -2.53990634e-03,
   3.35732959e+02, -2.78172405e+00,  4.35688140e-02, -2.56185608e+01,
  -8.57880055e-01,  1.14498589e+01],
 [ 6.97364761e-04, -1.69822953e-03, -1.50038888e-03,  1.55833229e-01,
   4.35495107e-03,  3.37993968e-04, -2.53239678e+00, -3.46888169e-01,
  -9.59847063e-04, -3.64929842e+01, -5.19628004e+02,  6.89608507e-02,
  -2.78172405e+00,  1.15966693e+03, -6.58932711e-01, -5.19065971e+02,
  -7.11976589e+01, -7.73298220e-01],
 [-1.45249418e-03,  1.02287835e-02, -3.57757724e-03, -7.62474212e-01,
   6.59363301e-03,  9.03780585e-03,  1.33539163e+01, -6.02325388e-01,
  -2.69293991e-02, -7.93643116e-01, -7.12189838e+01, -5.30050908e+02,
   4.35688140e-02, -6.58932711e-01,  1.21492592e+03,  8.53561617e-02,
  -5.29895884e+02, -2.51714904e-01],
 [-5.77422832e-05,  1.31585003e-04,  1.35154543e-04, -1.19367956e-02,
  -3.91202755e-04, -3.61617393e-05,  1.81450641e-01,  3.09637643e-02,
   1.06327833e-04, -2.78225779e+00, -4.12093822e-01, -7.84604430e-03,
  -2.56185608e+01, -5.19065971e+02,  8.53561617e-02,  5.99839347e+02,
  -7.72915133e-01, -5.50912635e+01],
 [ 5.42222053e-05, -6.99688305e-04,  3.83815507e-04,  3.81472164e-02,
  -6.50156010e-04, -9.74280110e-04, -7.93625034e-01,  6.84428680e-02,
   2.80593241e-03,  1.33622961e+01, -6.58953039e-01, -1.99787355e-01,
  -8.57880055e-01, -7.11976589e+01, -5.29895884e+02, -7.72915133e-01,
   1.21485877e+03, -5.29559147e+02],
 [-3.24063073e-06,  7.23032131e-05, -4.39709201e-05, -2.59213268e-03,
   6.25757165e-05,  1.27239557e-04,  4.34636434e-02, -7.78511565e-03,
  -3.59835687e-04, -8.57562659e-01,  8.54820589e-02,  2.51845913e-02,
   1.14498589e+01, -7.73298220e-01, -2.51714904e-01, -5.50912635e+01,
  -5.29559147e+02,  6.41902613e+02]
])  # 阻尼矩阵
#C = np.array([
    #[1.884881, -0.93423, 0, 0, 0, 0, 0, 0, 0, 0],
    #[--0.93423, 1.884881, -0.93423, 0, 0, 0, 0, 0, 0, 0],
    #[0, -0.93423, 1.884881, -0.93423, 0, 0, 0, 0, 0, 0],
    #[0, 0, -0.93423, 1.884881, -0.93423, 0, 0, 0, 0, 0],
    #[0, 0, 0, -0.93423, 1.884881, -0.93423, 0, 0, 0, 0],
    #[0, 0, 0, 0, -0.93423, 1.884881, -0.93423, 0, 0, 0],
    #[0, 0, 0, 0, 0, -0.93423, 1.884881, -0.93423, 0, 0],
    #[0, 0, 0, 0, 0, 0, -0.93423, 1.884881, -0.93423, 0],
    #[0, 0, 0, 0, 0, 0, 0, -0.93423, 1.884881, -0.93423],
    #[0, 0, 0, 0, 0, 0, 0, 0, -0.93423, 0.950648]
#])  # 阻尼系数矩阵

DOF = M.shape[0]  # 计算自由度

# 模态分析
eigenvalues, eigenvectors = StructDynSystem.ModalAnalyzer(M, K)
# 计算圆频率
wn = np.sqrt(eigenvalues).tolist()  # 计算圆频率
print("natural circular frequency of structure ωn:", wn)  # 打印圆频率
wn0=wn[0] # 计算主频率
##########################################
# 设置时间范围
time = 10.0  # 总模拟时间（单位：秒）

# 定义荷载函数结构，其中 t 和Pt 都是张量
def Pt_func(t):
    Pt = [500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t), 500*torch.sin(5.236*t)]
    #Pt =  [torch.sin(t)+torch.cos(t),torch.sin(t),...] #按照自由度顺序，列表里面给出每个自由度的外荷载Pt
    return Pt
################ 神经网络超参数设置 #################
# 定义超参数
Adamsteps = 15000  # Adam优化算法的训练步数
LBFGSsteps = 35000  # L-BFGS优化算法的训练步数
init_lr = 0.001  # 初始学习率
NumberODE = int(time * 90)  # 常微分方程（ODE）采样点数
NumberInitial = int(time * 10)  # 初始条件采样点数
#############################################

############################FKAN##############
layer_size = [1] + [60]*3  + [DOF]  # 输入层+隐藏层+输出层
net = NeuralNetwork.KAN(layer_size, grid_size=int(time)*5, grid_range=[0.0, time]).to(DEVICE)  # 采用KAN神经网络

# 结构动力系统参数
StructDynSystemParm = StructDynSystem.StructDynSystemParm(M, C, K)

# 结构动力系统中Pt荷载输入
inputPt = StructDynSystem.inputPtFunc(StructDynSystemParm, time, Pt_func)

# 结构动力系统的损失函数
loss_functions = LossFunctions.LossPtFunc(net, StructDynSystemParm, inputPt, NumberODE, NumberInitial)

# 创建训练器并训练
trainer = Trainer.TrainerForwardProblem(net, loss_functions, Adamsteps, LBFGSsteps)
trainer.train_with_adam(init_lr)  # 使用 Adam 训练
trainer.train_with_lbfgs()  # 使用 L-BFGS 训练

# 将模型训练结果保存到文件
torch.save(trainer.results, 'example2.pth')

# 可视化结果
visualizer = Postprocessor.Visualizer()
visualizer.plot_loss_curve(trainer.losses)
visualizer.plot_displacement(trainer.results,steps=2000)

