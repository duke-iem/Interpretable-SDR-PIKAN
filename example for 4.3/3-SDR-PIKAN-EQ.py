"""
solve the following ODE of MDOF
M*U_dotdot+C*U_dot+K*U=Pt with initial condition: U(t=0)=0, and U_dot(t=0)=0
Pt is the earthquake ground motion, loaded from a file
Author: 杜轲 duke@iem.ac.cn
Date: 2024/11/3
"""
###########################环境配置##################
# 导入所需的库
from AIStructDynSolve import *
import numpy as np
import pandas as pd
import torch
################ 输入结构动力学参数 #################
# 定义质量矩阵
#mass = np.array([20000.0, 20000.0])  # 质量数组
M = np.array([
    [1.727880e+04,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00],
    [0.000000e+00,3.321647e+04,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00],
    [0.000000e+00,0.000000e+00,3.321647e+04,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00],
    [0.000000e+00,0.000000e+00,0.000000e+00,3.321647e+04,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00],
    [0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,1.727880e+04,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00],
    [0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,1.649527e+04,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00],
    [0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,3.231997e+04,0.000000e+00,0.000000e+00,0.000000e+00],
    [0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,3.231997e+04,0.000000e+00,0.000000e+00],
    [0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,3.231997e+04,0.000000e+00],
    [0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,0.000000e+00,1.649527e+04]
])   # 质量数组

# 定义刚度矩阵
K = np.array([
    [6.756916e+08, -6.343426e+08, -2.350302e+05, 4.016755e+04, -5.386449e+03, -2.538961e+07, -1.171945e+06, 1.785699e+05, -2.590884e+04, 3.921521e+03],
    [-6.343426e+08, 1.333610e+09, -6.359865e+08, -8.820648e+04, 2.480929e+04, -6.967796e+06, -3.898578e+07, -2.461238e+05, 8.584608e+04, -1.822971e+04],
    [-2.350302e+05, -6.359865e+08, 1.334209e+09, -6.360360e+08, -1.021865e+05, 5.146394e+05, -5.847759e+06, -3.932184e+07, -2.213777e+05, 1.121481e+05],
    [4.016755e+04, -8.820648e+04, -6.360360e+08, 1.334190e+09, -6.358522e+08, -5.679023e+04, 4.041516e+05, -5.823013e+06, -3.927602e+07, -4.171323e+05],
    [-5.386449e+03, 2.480929e+04, -1.021865e+05, -6.358522e+08, 6.880566e+08, 8.119582e+03, -4.911110e+04, 4.482176e+05, -6.212983e+06, -3.157215e+07],
    [-2.538961e+07, -6.967796e+06, 5.146394e+05, -5.679023e+04, 8.119582e+03, 6.348506e+08, -6.026773e+08, -3.133937e+05, 3.750997e+04, -6.020552e+03],
    [-1.171945e+06, -3.898578e+07, -5.847759e+06, 4.041516e+05, -4.911110e+04, -6.026773e+08, 1.251870e+09, -6.033352e+08, -2.449988e+05, 3.750997e+04],
    [1.785699e+05, -2.461238e+05, -3.932184e+07, -5.823013e+06, 4.482176e+05, -3.133937e+05, -6.033352e+08, 1.252061e+09, -6.033352e+08, -3.133937e+05],
    [-2.590884e+04, 8.584608e+04, -2.213777e+05, -3.927602e+07, -6.212983e+06, 3.750997e+04, -2.449988e+05, -6.033352e+08, 1.251870e+09, -6.026773e+08],
    [3.921521e+03, -1.822971e+04, 1.121481e+05, -4.171323e+05, -3.157215e+07, -6.020552e+03, 3.750997e+04, -3.133937e+05, -6.026773e+08, 6.348506e+08]
])  # 刚度矩阵

# 定义阻尼矩阵
C = np.array([
    [9.300923e+05,-8.522457e+05,-3.157655e+02,5.396551e+01,-7.236749e+00,-3.411121e+04,-1.574520e+03,2.399105e+02,-3.480879e+01,5.268603e+00],
    [-8.522457e+05,1.834576e+06,-8.544543e+05,-1.185063e+02,3.333153e+01,-9.361305e+03,-5.237780e+04,-3.306699e+02,1.153351e+02,-2.449180e+01],
    [-3.157655e+02,-8.544543e+05,1.835381e+06,-8.545208e+05,-1.372887e+02,6.914233e+02,-7.856524e+03,-5.282929e+04,-2.974233e+02,1.506721e+02],
    [5.396551e+01,-1.185063e+02,-8.545208e+05,1.835356e+06,-8.542739e+05,-7.629825e+01,5.429818e+02,-7.823278e+03,-5.276774e+04,-5.604215e+02],
    [-7.236749e+00,3.333153e+01,-1.372887e+02,-8.542739e+05,9.467049e+05,1.090874e+01,-6.598127e+01,6.021849e+02,-8.347206e+03,-4.241750e+04],
    [-3.411121e+04,-9.361305e+03,6.914233e+02,-7.629825e+01,1.090874e+01,8.742112e+05,-8.097031e+05,-4.210477e+02,5.039503e+01,-8.088673e+00],
    [-1.574520e+03,-5.237780e+04,-7.856524e+03,5.429818e+02,-6.598127e+01,-8.097031e+05,1.723601e+06,-8.105870e+05,-3.291584e+02,5.039503e+01],
    [2.399105e+02,-3.306699e+02,-5.282929e+04,-7.823278e+03,6.021849e+02,-4.210477e+02,-8.105870e+05,1.723858e+06,-8.105870e+05,-4.210477e+02],
    [-3.480879e+01,1.153351e+02,-2.974233e+02,-5.276774e+04,-8.347206e+03,5.039503e+01,-3.291584e+02,-8.105870e+05,1.723601e+06,-8.097031e+05],
    [5.268603e+00,-2.449180e+01,1.506721e+02,-5.604215e+02,-4.241750e+04,-8.088673e+00,5.039503e+01,-4.210477e+02,-8.097031e+05,8.742112e+05]
])  # 阻尼系数矩阵

DOF = M.shape[0]  # 计算自由度

# 模态分析
eigenvalues, eigenvectors = StructDynSystem.ModalAnalyzer(M, K)
# 计算圆频率
wn = np.sqrt(eigenvalues).tolist()  # 计算圆频率
print("Natural circular frequency of structure ωn:", wn)  # 打印圆频率
wn0=wn[0] # 计算主频率
##########################################
# 设置时间范围
time = 16.26  # 总模拟时间（单位：秒）
################ 读取地震波数据 ####################
# 从文件读取地震波数据
df  = np.loadtxt("example3 - Earthquake.txt", skiprows=1)
EQscalefactor = 9.8  # 设置加速度放大系数
EQtime = df[:, 0]  # 提取时间数据
EQacc = df[:, 1] * EQscalefactor # 提取加速度数据并根据放大系数缩放

################ 神经网络超参数设置 #################
# 定义超参数
Adamsteps = 20000  # Adam优化算法的训练步数
LBFGSsteps = 20000 # L-BFGS优化算法的训练步数
init_lr = 0.001  # 初始学习率
NumberODE = int(time * 90)  # 常微分方程（ODE）采样点数
NumberInitial = int(time * 10)  # 初始条件采样点数
#############################################

############################FKAN##############
layer_size = [1] + [60]*1  + [DOF]  # 输入层+隐藏层+输出层
net = NeuralNetwork.FKAN(layer_size, grid_size=int(time)*1).to(DEVICE)

# 结构动力系统参数
StructDynSystemParm = StructDynSystem.StructDynSystemParm(M, C, K)

# 地震波输入
inputEQ = StructDynSystem.inputEQ(StructDynSystemParm, time, EQtime, EQacc)

# 结构动力系统的损失函数
loss_functions = LossFunctions.LossEQ(net, StructDynSystemParm, inputEQ, NumberODE, NumberInitial)

# 创建训练器并训练
trainer = Trainer.TrainerForwardProblem(net, loss_functions, Adamsteps, LBFGSsteps)
trainer.train_with_adam(init_lr)  # 使用 Adam 训练
trainer.train_with_lbfgs()  # 使用 L-BFGS 训练

# 将模型训练结果保存到文件
torch.save(trainer.results, 'example3.pth')

# 可视化结果
visualizer = Postprocessor.Visualizer()
visualizer.plot_loss_curve(trainer.losses)
visualizer.plot_displacement(trainer.results,steps=3252)
